{% extends "virksomhet_index.html" %}
{% load static %}
{% load humanize %}
{% load templatetags %}

{% block ekstrajavascript %}
	<script src="{% static 'cytoscape/cytoscape.min.js@3.9.4' %}" nonce="{{request.csp_nonce}}"></script>
	<script src="{% static 'cytoscape/numeric.min.js@1.2.6' %}" nonce="{{request.csp_nonce}}"></script>
	<script src="{% static 'cytoscape/layout-base.js@1.0.1' %}" nonce="{{request.csp_nonce}}"></script>
	<script src="{% static 'cytoscape/cose-base.js@1.0.1' %}" nonce="{{request.csp_nonce}}"></script>
	<script src="{% static 'cytoscape/cytoscape-layout-utilities.js@1.0.0' %}" nonce="{{request.csp_nonce}}"></script>
	<script src="{% static 'cytoscape/cytoscape-fcose.js' %}" nonce="{{request.csp_nonce}}"></script>
{% endblock ekstrajavascript %}


{% block ekstrameny %}

	{% include 'virksomhet_detaljer_ekstrameny.html' %}

{% endblock ekstrameny %}

{% block overskrift %}
	{{ virksomhet.virksomhetsnavn }} ({{ virksomhet.virksomhetsforkortelse }})
{% endblock overskrift %}

{% block hovedinnhold %}

	{% if virksomhet.orgnummer %} Organisasjonsnummer {{ virksomhet.orgnummer|intcomma }} {% endif %}<br>
	<hr>

	{% if virksomhet.overordnede_virksomheter.all|length > 0 %}
	<h6>Underlangt
	{% for vir in virksomhet.overordnede_virksomheter.all %}
		{% url 'virksomhet' vir.pk as url_vir %}
		<a href="{{ url_vir }}">{{ vir }}</a>
	{% endfor %}
	</h6>
	{% endif %}

	{% if virksomhet.underliggende_virksomheter.all|length > 0 %}
		<h6>Har ansvar for</h6>
		{% for underliggende in virksomhet.underliggende_virksomheter.all %}
			{% url 'virksomhet' underliggende.pk as url_vir %}
			<li><a href="{{ url_vir }}">{{ underliggende }}</a></li>
		{% endfor %}
		<hr>
	{% endif %}

	Vi benytter <b>{{ant_systemer_bruk}}</b> systemer<br>
	Vi eier <b>{{ant_systemer_eier}}</b> systemer, forvalter <b>{{ant_systemer_forvalter}}</b> systemer og drifter <b>{{systemer_drifter}}</b> systemer<br>
	Vi har <b>{{ antall_brukere }}</b> interne og <b>{{ antall_eksterne_brukere }}</b> ekstern brukere i brukerkatalogen<br>

	<hr>

	<a class="btn btn-sm btn-link" href="/admin/systemoversikt/virksomhet/{{ virksomhet.pk }}/change/">
	{% include 'site_edit_button.html' %} Rediger virksomhetsdetaljer og kontaktpersoner</a>

	<hr>

	{% if virksomhet.intranett_url %}
		<a class="btn btn-sm btn-link" href="{{ virksomhet.intranett_url }}" target="_blank">üåç {{virksomhet.virksomhetsforkortelse}}s intranettside</a>
	{% endif %}
	{% if virksomhet.www_url %}
		<a class="btn btn-sm btn-link" href="{{ virksomhet.www_url }}" target="_blank">üåç {{virksomhet.virksomhetsforkortelse}}s nettside</a>
	{% endif %}
	{% if virksomhet.styringssystem %}
		<a class="btn btn-sm btn-link" href="{{ virksomhet.styringssystem }}" target="_blank">üåç {{virksomhet.virksomhetsforkortelse}}s styringssystem</a>
	{% endif %}


	<table class="table">
	<thead>
	<tr>
		<th style="width: 200px;">Sentrale roller</th>
		<th>Kontaktpersoner</th>
	</tr>
	</thead>
	<tbody>
	<tr>
		<td>Etatsdirekt√∏r</td>
		<td>
		{% if virksomhet.leder_hr %}
			<a href="{% url 'bruker_detaljer' pk=virksomhet.leder_hr.pk %}">{{virksomhet.leder_hr.profile.displayName}}</a>
		{% else %}
			<i>Ingen data fra HR tilgjengelig</i>
		{% endif %}
		</td>
	</tr>
	<tr>
		<td>Aktitekturkontakter</td>
		<td>{% include "ansvarlig_include_vis.html" with ansvarlige=virksomhet.arkitekturkontakter.all %}</td>
	</tr>
	<tr>
		<td>IKT-kontakter</td>
		<td>{% include "ansvarlig_include_vis.html" with ansvarlige=virksomhet.ikt_kontakt.all %}</td>
	</tr>
	<tr>
		<td>Personvernkoordinator</td>
		<td>{% include "ansvarlig_include_vis.html" with ansvarlige=virksomhet.personvernkoordinator.all %}</td>
	</tr>
	<tr>
		<td>Informasjonvernkoordinator</td>
		<td>{% include "ansvarlig_include_vis.html" with ansvarlige=virksomhet.informasjonssikkerhetskoordinator.all %}</td>
	</tr>
	<tr>
		<td>Sikkerhetsrelaterte varsler sendes til</td>
		<td>{% include "ansvarlig_include_vis.html" with ansvarlige=virksomhet.varslingsmottak_sikkerhet_ref.all %}</td>
	</tr>
	<tr>
		<td>Kundekontakt i UKE</td>
		<td>{% include "ansvarlig_include_vis.html" with ansvarlige=virksomhet.uke_kam_referanse.all %}</td>
	</tr>
	<tr>
		<td>Infotorg autorisert bestiller</td>
		<td>{% include "ansvarlig_include_vis.html" with ansvarlige=virksomhet.autoriserte_bestillere_tjenester.all %}</td>
	</tr>
	<tr>
		<td>Folkeregisteradministrator i KS Fiks</td>
		<td>{% include "ansvarlig_include_vis.html" with ansvarlige=virksomhet.ks_fiks_admin_ref.all %}</td>
	</tr>
	<tr>
		<td>Autoriserte bestillere av sertifikater fra Buypass via Sopra Steria</td>
		<td>Se <a href="{% url 'sertifikatmyndighet' %}">avgitte fullmakter</a></td>
	</tr>
	<tr>
		<td>Autorisert for bestilling av tjenester fra UKE</td>
		<td>{% include "ansvarlig_include_vis.html" with ansvarlige=virksomhet.autoriserte_bestillere_tjenester_uke.all %}</td>
	</tr>
	</tbody>
	</table>


	<hr>

	<h6>Avdelinger</h6>
	<div class="row" style="width: 800px;">
		<div class="col-sm-12">
			<ul style="column-count: 2;">
			{% for u in enheter %}
				{% url 'enhet_detaljer' pk=u.pk as url_enhet %}
				<li><a href="{{url_enhet}}">{{ u }}</a></li>
			{% empty %}
				<li>Ingen</li>
			{% endfor %}
			</ul>
		</div>
	</div>

	<hr>

	<h6>Systemansvar fordelt p√• seksjoner</h6>
	<table style="width: 800px;">
		<tr>
			<td>
				<a href="{% url 'virksomhet_figur_system_seksjon' pk=virksomhet.pk %}?kilde=tjenester" style="margin-left: 50px;">Tjenester: √•pne i st√∏rre vindu</a>
				<div id="cy_tjenester" style="width: 400px; height: 300px;"></div>
			</td>
			<td>
				<a href="{% url 'virksomhet_figur_system_seksjon' pk=virksomhet.pk %}?kilde=infrastruktur" style="margin-left: 50px;">Infrastruktur: √•pne i st√∏rre vindu</a>
				<div id="cy_infra" style="width: 400px; height: 300px;"></div>
			</td>
		</tr>
	</table>


	<hr>

	<h6>Systemavhengigheter for v√•re systemer</h6>
	<p>Virksomhetsforvaltere og superbrukere kan flytte rundt p√• nodene i grafen og nye lokasjoner vil bli lagret for alle.</p>

	<div id="cy_avhengigheter" style="background-color: #FCFCFC; border: 1px solid #d6d4d4; width: 100%; height: 1000px;"></div>

	<br>
	<button id="graph-reset" class="btn btn-sm btn-outline-secondary">Tilbakestill visning</button>
	<button id="graph-download" class="btn btn-secondary">Last ned layout</button>
	<button id="graph-upload" class="btn btn-secondary">Last inn layout</button>
	<input id="graph-upload-input" type="file" accept="application/json" style="display:none;">
	<button id="graph-lock"></button>



	{% if avhengigheter_graf_ny.nodes|length < 2 %}
		<p>Ingen systemer √• vise</p>
	{% endif %}

	<hr>

	<h5>Kritiske funksjoner knyttet til v√•re systemer</h5>
	<table class="table table-sm excel">
	<thead>
	<tr>
		<th>Omr√•de</th>
		<th>Kritisk funksjon</th>
		<th>Systemknytninger</th>
	</tr>
	</thead>
	<tbody>
	{% for funksjon in kritiske_funksjoner %}
	<tr>
		<td>{{funksjon.get_kategori_display}}</td>
		<td>{{funksjon.navn}}</td>
		<td>
			{% for system in funksjon.systemer %}
				{% if system.systemforvalter == virksomhet %}
					<li>{{system}}
						<ul>
						{% for kapabilitet in system.kritisk_kapabilitet.all %}
							<li>{{kapabilitet}}</li>
						{% endfor %}
						</ul>
					</li>
				{% endif %}
			{% endfor %}
		</td>
	</tr>
	{% endfor %}
	</tbody>
	</table>

	<hr>

{% endblock hovedinnhold %}

{% block script_append %}


{{ saved_layout_json|json_script:"savedLayoutData" }}

<script type="text/javascript" nonce="{{request.csp_nonce}}">
// -------------------------------
// Debug helpers
// -------------------------------
const DEBUG = true;
const log = (...args) => { if (DEBUG) console.log('[Graph]', ...args); };
const group = (label) => { if (DEBUG) console.group(label); };
const groupCollapsed = (label) => { if (DEBUG) console.groupCollapsed(label); };
const groupEnd = () => { if (DEBUG) console.groupEnd(); };

// -------------------------------
// CSRF helpers: prefer server token, fallback to cookie
// -------------------------------
function getCookie(name){
  const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return m ? m.pop() : '';
}
const CSRF_TEMPLATE = "{{ csrf_js_token|default:'' }}";
const CSRF = (CSRF_TEMPLATE && CSRF_TEMPLATE.length === 64) ? CSRF_TEMPLATE : getCookie('csrftoken');

// -------------------------------
// Saved layout from server
// -------------------------------

const savedLayout = JSON.parse(
    document.getElementById('savedLayoutData').textContent
);


const hasSaved = !!(savedLayout && savedLayout.positions && Object.keys(savedLayout.positions).length);
log('Init: hasSaved =', hasSaved, savedLayout ? {
  zoom: savedLayout.zoom,
  pan: savedLayout.pan,
  positionsCount: Object.keys(savedLayout.positions || {}).length
} : 'no savedLayout');

// Pre-sanitize saved positions (numbers only)
const savedPositionsRaw = {};
if (hasSaved) {
  for (const [id, p] of Object.entries(savedLayout.positions)) {
    const x = p && Number.isFinite(+p.x) ? +p.x : null;
    const y = p && Number.isFinite(+p.y) ? +p.y : null;
    if (x !== null && y !== null) savedPositionsRaw[id] = { x, y };
  }
}

// -------------------------------
// INIT CYTOSCAPE
// -------------------------------
groupCollapsed('Cytoscape init');
log('Mounting cytoscape with layout =', hasSaved ? 'preset' : 'fcose');

var cy_avhengigheter = cytoscape({
  container: document.getElementById('cy_avhengigheter'),

  zoomingEnabled: true,
  panningEnabled: true,
  wheelSensitivity: 0.1,
  minZoom: 0.01,
  maxZoom: 10,
  autolock: false,
  autoungrabify: false,
  boxSelectionEnabled: false,

  elements: {
    nodes: [
      {% for node in avhengigheter_graf_ny.nodes %} {{ node|safe }},
      {% endfor %}
    ],
    edges: [
      {% for edge in avhengigheter_graf_ny.edges %} {{ edge|safe }},
      {% endfor %}
    ],
  },

  style: [
    {
      selector: 'node',
      style: {
        'shape': 'data(shape)',
        'background-color': 'data(color)',
        'label': 'data(name)',
        'font-size': '11px',
      },
    },
    {
      selector: 'edge',
      style: {
        'target-arrow-shape': 'triangle',
        'curve-style': 'bezier',
        'line-style': 'data(linestyle)',
        'line-color': 'data(linecolor)',
        'target-arrow-color': 'data(linecolor)',
        'width': 'data(linewidth)',
        'target-distance-from-node': 15,
        'source-distance-from-node': 25,
      },
    },
    {
      selector: ':parent',
      style: {
        'label': 'data(name)',
        'background-color': '#F1F9FF',
        'padding': 10,
        // Avoid parent bbox changing due to label metrics after render
        'compound-sizing-wrt-labels': 'exclude'
      }
    }
  ],

  // Use PRESET if we have saved positions; else deterministic fCoSE
  layout: hasSaved
    ? {
        name: 'preset',
        positions: savedPositionsRaw, // initial map; we‚Äôll refine to :childless after init
        fit: false                     // viewport restored separately
      }
    : {
        name: 'fcose',
        fit: true,
        packComponents: true,
        animationDuration: 0,
        idealEdgeLength: 100,
        quality: "proof",
        numIter: 50000,
        nodeSeparation: 80,
        uniformNodeDimensions: true,
        randomize: false
        // seed: 42 // optional for strict repeatability
      }
});

groupEnd(); // Cytoscape init


// ---------------------------------------------
// OPEN LINKS ON NODE CLICK
// ---------------------------------------------
cy_avhengigheter.on('tap', 'node', function(){
  const href = this.data('href');
  if (href) {
    log('Node tap ‚Üí navigating', { id: this.id(), href });
    try { window.open(href, "_self"); }
    catch(e){ log('window.open failed, fallback to location.href', e); window.location.href = href; }
  } else {
    log('Node tap (no href)', { id: this.id() });
  }
});


// ---------------------------------------------
// SAVE / RESTORE STATE
// ---------------------------------------------
let saveTimeout = null;
let isRestoring = false;
let restoreGraceUntil = 0; // ms timestamp; avoid saving mid-restore

function scheduleSave(source) {
  const now = Date.now();
  if (isRestoring || now < restoreGraceUntil) {
    log('scheduleSave ignored (restoring/grace)‚Ä¶', { source });
    return;
  }
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(() => saveLayout(source), 800);
}

// Clamp & sanitize viewport
function clampViewportForCy(cy, z, pan) {
  const minZ = Math.max(0.02, cy.minZoom() || 0.01);
  const maxZ = Math.min(8, cy.maxZoom() || 10);
  const zoom = Math.min(maxZ, Math.max(minZ, Number.isFinite(z) ? z : 1));
  const safePan = {
    x: Number.isFinite(pan && pan.x) ? pan.x : 0,
    y: Number.isFinite(pan && pan.y) ? pan.y : 0
  };
  return { zoom, pan: safePan };
}

async function saveLayout(source) {
  saveTimeout = null;

  const rawZoom = cy_avhengigheter.zoom();
  const rawPan = cy_avhengigheter.pan();
  const v = clampViewportForCy(cy_avhengigheter, rawZoom, rawPan);

  // Save only childless, visible nodes (avoid compounds & hidden)
  const positions = {};
  cy_avhengigheter.nodes(':childless:visible').forEach(n => {
    const p = n.position();
    positions[n.id()] = { x: p.x, y: p.y };
  });

  groupCollapsed('SaveLayout ‚Üí start');
  log('Source:', source);
  log('Counts:', { nodesAll: cy_avhengigheter.nodes().length, nodesSaved: Object.keys(positions).length, edges: cy_avhengigheter.edges().length });
  log('Viewport (clamped):', v);

  try {
    const resp = await fetch("{% url 'virksomhet_save_graph_layout' virksomhet.pk %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": CSRF
      },
      credentials: "same-origin",
      body: JSON.stringify({ positions, zoom: v.zoom, pan: v.pan })
    });

    const text = await resp.text();
    if (!resp.ok) {
      log('SaveLayout ‚Üí non-OK', { status: resp.status, statusText: resp.statusText, bodyStart: text.slice(0, 200) });
    } else if (!text.startsWith('{"ok":')) {
      log('SaveLayout ‚Üí unexpected body (not JSON starting with {"ok":)', { bodyStart: text.slice(0, 200) });
    } else {
      log('SaveLayout ‚Üí success');
    }
  } catch (err) {
    log('SaveLayout ‚Üí fetch error', err);
  } finally {
    groupEnd();
  }
}

cy_avhengigheter.on('position', 'node', () => scheduleSave('node:position'));
cy_avhengigheter.on('pan', () => scheduleSave('viewport:pan'));
cy_avhengigheter.on('zoom', () => scheduleSave('viewport:zoom'));


// ---------------------------------------------
// RESTORE VIEWPORT (positions via preset)
// ---------------------------------------------
function endRestore(reason = 'unknown') {
  if (!isRestoring) return;
  isRestoring = false;
  restoreGraceUntil = Date.now() + 200; // small grace so we don‚Äôt save mid-frame
  log('Restore ‚Üí complete; saving re-enabled (reason:', reason, ')');
  try { groupEnd(); } catch(_) {}
}

function applyViewportOnce(zoom, pan) {
  const v = clampViewportForCy(cy_avhengigheter, zoom, pan);
  cy_avhengigheter.startBatch();
  // Re-apply saved positions strictly for childless nodes only
  if (hasSaved) {
    cy_avhengigheter.nodes(':childless').forEach(n => {
      const sp = savedPositionsRaw[n.id()];
      if (sp) n.position(sp);
    });
  }
  cy_avhengigheter.zoom(v.zoom);
  cy_avhengigheter.pan(v.pan);
  cy_avhengigheter.endBatch();
  // Keep style/layout synced with actual container size
  cy_avhengigheter.resize();
  cy_avhengigheter.style().update();
}

if (hasSaved) {
  isRestoring = true;
  group('Restore ‚Üí start');

  // Safety net
  const timeoutId = setTimeout(() => endRestore('timeout-1500ms'), 1500);



  // Apply after preset positions settle
  cy_avhengigheter.once('idle', () => {
    log('Restore: idle ‚Üí apply viewport');
    applyViewportOnce(savedLayout.zoom, savedLayout.pan);

    // End restore when painted / next frame
    cy_avhengigheter.once('render', () => endRestore('render'));
    cy_avhengigheter.once('layoutstop', () => endRestore('layoutstop'));
    requestAnimationFrame(() => endRestore('rAF-after-viewport'));
  });

  // One-time re-apply if container size changes after mount (flex/grid/fonts)
  let resizeHandled = false;
  const onFirstResize = () => {
    if (resizeHandled) return;
    resizeHandled = true;
    log('Restore: first resize ‚Üí re-apply viewport');
    applyViewportOnce(savedLayout.zoom, savedLayout.pan);
    cy_avhengigheter.off('resize', onFirstResize);
    requestAnimationFrame(() => endRestore('first-resize'));
  };
  cy_avhengigheter.on('resize', onFirstResize);

  // Backup if 'ready' fires later in your environment
  cy_avhengigheter.once('ready', () => {
    if (!isRestoring) return;
    log('Restore: ready ‚Üí backup apply');
    applyViewportOnce(savedLayout.zoom, savedLayout.pan);
    requestAnimationFrame(() => endRestore('rAF-after-ready'));
  });

  // User interaction ends restore (prevents guard from blocking saves)
  const endOnUserAction = () => endRestore('user-action');
  cy_avhengigheter.once('grab', endOnUserAction);
  cy_avhengigheter.once('dragfree', endOnUserAction);
  cy_avhengigheter.once('pan', endOnUserAction);
  cy_avhengigheter.once('zoom', endOnUserAction);
} else {
  log('No saved layout ‚Üí deterministic fcose');
}
</script>



<script type="text/javascript" nonce="{{request.csp_nonce}}">
let isGraphLocked = {{ saved_layout_json.locked|yesno:"true,false" }};

// ---------------------------------------------------------
// Helper: update UI + cytoscape interaction states
// ---------------------------------------------------------
function applyLockStateUI(locked) {
    const btn = document.getElementById("graph-lock");
    if (!btn) return;

    // Text
    btn.textContent = locked ? "üîí L√•s opp" : "L√•s";

    // Always ensure base class is present
    // (the original HTML was: <button class="btn">)
    btn.classList.add("btn");

    // Toggle locked visual state
    if (locked) {
        btn.classList.add("btn-danger");     // Add red when locked
    } else {
        btn.classList.remove("btn-danger");  // Remove red when unlocked
    }

    // Lock interactions
    cy_avhengigheter.autolock(locked);
    cy_avhengigheter.autoungrabify(locked);

    // Allow pan/zoom during initial restore always
    if (isRestoring) {
        // Defer disabling until restore has ended
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                cy_avhengigheter.zoomingEnabled(!locked);
                cy_avhengigheter.panningEnabled(!locked);
            });
        });
    } else {
        // Normal behavior
        cy_avhengigheter.zoomingEnabled(!locked);
        cy_avhengigheter.panningEnabled(!locked);
    }

    log(locked ? "Graph is LOCKED. Edits disabled."
               : "Graph UNLOCKED. Editing enabled.");
}

// ---------------------------------------------------------
// Disable saving when locked
// ---------------------------------------------------------
function scheduleSaveLockedSafe(source) {
    if (isGraphLocked) {
        log("Save ignored, graph locked.", { source });
        return;
    }
    scheduleSave(source);
}

// ---------------------------------------------------------
// REMOVE ORIGINAL SAVE LISTENERS
// (Critical! Prevents double events)
// ---------------------------------------------------------
cy_avhengigheter.off('position');
cy_avhengigheter.off('pan');
cy_avhengigheter.off('zoom');

// ---------------------------------------------------------
// REPLACE WITH LOCK-AWARE SAVE LISTENERS
// ---------------------------------------------------------
cy_avhengigheter.on('position', 'node', () => scheduleSaveLockedSafe('node:position'));
cy_avhengigheter.on('pan', () => scheduleSaveLockedSafe('viewport:pan'));
cy_avhengigheter.on('zoom', () => scheduleSaveLockedSafe('viewport:zoom'));


// ---------------------------------------------------------
// Toggle lock (frontend + backend)
// ---------------------------------------------------------
document.getElementById("graph-lock")?.addEventListener("click", async () => {
    const newState = !isGraphLocked;

    try {
        const r = await fetch("{% url 'virksomhet_toggle_graph_lock' virksomhet.pk %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": CSRF
            },
            body: JSON.stringify({ locked: newState }),
            credentials: "same-origin"
        });

        const result = await r.json();
        if (result.ok) {
            isGraphLocked = result.locked;
            applyLockStateUI(isGraphLocked);
        } else {
            alert("Kunne ikke endre l√•sestatus.");
        }
    } catch (e) {
        alert("Nettverksfeil ved toggling av l√•s.");
    }
});

// Initial setup on load
applyLockStateUI(isGraphLocked);
</script>



<script type="text/javascript" nonce="{{request.csp_nonce}}">
// ---------------------------------------------
// RESET LAYOUT
// ---------------------------------------------
document.getElementById('graph-reset')?.addEventListener('click', () => {
  // Guard saving during reset
  isRestoring = true;

  // Clear positions only for childless nodes (parents autosize)
  cy_avhengigheter.startBatch();
  cy_avhengigheter.nodes(':childless').forEach(n => n.removeData('position'));
  cy_avhengigheter.endBatch();

  // Run deterministic fcose once
  const layout = cy_avhengigheter.layout({
    name: 'fcose',
    fit: true,
    packComponents: true,
    animationDuration: 0,
    idealEdgeLength: 100,
    quality: 'proof',
    numIter: 50000,
    nodeSeparation: 80,
    uniformNodeDimensions: true,
    randomize: false
    // seed: 42
  });
  layout.run();

  // Re-enable saving after layout completes (with tiny grace)
  cy_avhengigheter.once('layoutstop', () => {
    setTimeout(() => {
      isRestoring = false;
      restoreGraceUntil = Date.now() + 200;
    }, 0);
  });
});
</script>


<script type="text/javascript" nonce="{{request.csp_nonce}}">
// ---------------------------------------------
// DOWNLOAD LAYOUT AS FILE
// ---------------------------------------------
function downloadLayoutAsFile() {
    // Collect positions (only childless visible nodes, like your save logic)
    const positions = {};
    cy_avhengigheter.nodes(':childless:visible').forEach(n => {
        const p = n.position();
        positions[n.id()] = { x: p.x, y: p.y };
    });

    // Collect viewport
    const zoom = cy_avhengigheter.zoom();
    const pan = cy_avhengigheter.pan();

    const payload = {
        positions,
        zoom,
        pan
    };

    const blob = new Blob([JSON.stringify(payload, null, 2)], {
        type: "application/json"
    });

    // Create filename with timestamp
    const filename = `graph_layout_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;

    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;

    // Auto-click
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    URL.revokeObjectURL(url);
}

// Bind to button
document.getElementById('graph-download')?.addEventListener('click', () => {
    downloadLayoutAsFile();
});
</script>



<script type="text/javascript" nonce="{{request.csp_nonce}}">
// -------------------------------------------------------------
// LOAD LAYOUT FROM FILE
// -------------------------------------------------------------
function applyImportedLayout(data) {
    if (!data || typeof data !== "object") {
        alert("Ugyldig layoutfil.");
        return;
    }

    const { positions, zoom, pan } = data;

    if (!positions || typeof positions !== "object") {
        alert("Layoutfil mangler 'positions'.");
        return;
    }

    console.groupCollapsed("Import layout");

    // Disable auto-save while restoring
    isRestoring = true;

    cy_avhengigheter.startBatch();

    // Apply node positions to childless nodes only
    cy_avhengigheter.nodes(':childless').forEach(n => {
        const pos = positions[n.id()];
        if (pos && Number.isFinite(pos.x) && Number.isFinite(pos.y)) {
            n.position({ x: pos.x, y: pos.y });
        }
    });

    // Apply viewport
    if (Number.isFinite(zoom)) {
        cy_avhengigheter.zoom(zoom);
    }
    if (pan && Number.isFinite(pan.x) && Number.isFinite(pan.y)) {
        cy_avhengigheter.pan(pan);
    }

    cy_avhengigheter.endBatch();

    // Force style/layout update
    cy_avhengigheter.resize();
    cy_avhengigheter.style().update();

    // Re-enable saving after a short grace
    setTimeout(() => {
        isRestoring = false;
        restoreGraceUntil = Date.now() + 300;
    }, 100);

    console.groupEnd();
}

document.getElementById("graph-upload").addEventListener("click", () => {
    document.getElementById("graph-upload-input").click();
});

document.getElementById("graph-upload-input").addEventListener("change", (evt) => {
    const file = evt.target.files[0];
    if (!file) return;

    const reader = new FileReader();

    reader.onload = () => {
        try {
            const data = JSON.parse(reader.result);
            applyImportedLayout(data);
        } catch (e) {
            alert("Kunne ikke lese JSON fra filen.");
        }
    };

    reader.readAsText(file);
});
</script>





<script type="text/javascript" nonce="{{request.csp_nonce}}">
// -------------------------------------------------------------
// SYSTEMER FORDELT P√Ö AVDELINGER
// -------------------------------------------------------------
var cy_tjenester = cytoscape({
	zoomingEnabled: true,
	userZoomingEnabled: true,
	panningEnabled: true,
	container: document.getElementById('cy_tjenester'),
	elements: {
		nodes: [
			{% for node in nodes_tjenester %}
				{{ node|safe }},
			{% endfor %}
		],
		edges: [
		],
	},
	style: [
		{
			selector: 'node',
			style: {
				'label': 'data(name)',
				'shape': 'data(shape)',
				'background-color': 'data(color)',
				'width': '100',
				'height': '35',
				'font-size': '10',
				'text-valign': 'center',
				'text-halign': 'center',
			},
		},
		{
			selector: 'node:selected',
			style: {
			},
		},
		{
			selector: 'edge',
			style: {
				'target-arrow-shape': 'triangle',
				'curve-style': 'bezier',
				'line-style': 'data(linestyle)',
			},
		},
		{
			selector: 'edge:selected',
			style: {
			},
		},
		{
			selector: ':parent',
			style: {
				'label': 'data(name)',
				'font-size': '12',
				'line-style': "solid",
				'background-color': 'data(color)',
				'text-valign': 'top',
			}
		},
	],
	layout: {
		name: 'fcose',
		fit: true,
		packComponents: true,
		animationDuration: 0, //ms
		idealEdgeLength: 150,
	},
});

cy_tjenester.on('tap', 'node', function(){
	if (this.data('href')) {
		try { // your browser may block popups
			window.open( this.data('href'), "_blank" );
		} catch(e){ // fall back on url change
			window.location.href = this.data('href');
		}
	}
});
</script>


<script type="text/javascript" nonce="{{request.csp_nonce}}">
// -------------------------------------------------------------
// INFRASTRUKTUR FORDELT P√Ö AVDELINGER
// -------------------------------------------------------------
var cy_infra = cytoscape({
	zoomingEnabled: true,
	userZoomingEnabled: false,
	panningEnabled: true,
	container: document.getElementById('cy_infra'),
	elements: {
		nodes: [
			{% for node in nodes_infra %}
				{{ node|safe }},
			{% endfor %}
		],
		edges: [
		],
	},
	style: [
		{
			selector: 'node',
			style: {
				'label': 'data(name)',
				'shape': 'data(shape)',
				'background-color': 'data(color)',
				'width': '100',
				'height': '35',
				'font-size': '10',
				'text-valign': 'center',
				'text-halign': 'center',
			},
		},
		{
			selector: 'node:selected',
			style: {
			},
		},
		{
			selector: 'edge',
			style: {
				'target-arrow-shape': 'triangle',
				'curve-style': 'bezier',
				'line-style': 'data(linestyle)',
			},
		},
		{
			selector: 'edge:selected',
			style: {
			},
		},
		{
			selector: ':parent',
			style: {
				'label': 'data(name)',
				'font-size': '12',
				'line-style': "solid",
				'background-color': 'data(color)',
				'text-valign': 'top',
			}
		},
	],
	layout: {
		name: 'fcose',
		fit: true,
		packComponents: true,
		animationDuration: 0, //ms
		idealEdgeLength: 150,
	},
});

cy_infra.on('tap', 'node', function(){
	if (this.data('href')) {
		try { // your browser may block popups
			window.open( this.data('href'), "_self" );
		} catch(e){ // fall back on url change
			window.location.href = this.data('href');
		}
	}
});
</script>

{% endblock script_append %}

