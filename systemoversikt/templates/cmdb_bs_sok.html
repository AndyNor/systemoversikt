{% extends "cmdb_index.html" %}
{% load humanize %}
{% load static %}

{% block ekstrameny_business_service %}
{% endblock ekstrameny_business_service %}

{% block overskrift %}
	Business Sub Services (CMDB)
{% endblock overskrift %}

{% block hovedinnhold %}

	<p>CMDB står for "Configuration management database" og er i praksis en eller flere databaser med informasjon om hva et driftsmiljø består av. Sopra Steria har organisert servere og databaser under "miljø" som i  praksis er test/produksjon/kurs for et system. Hvert miljø er koblet til en kategori.

	I Kartoteket skal vi nå knytte systemet direkte til de miljø det består av. Denne knytningen vil skje fra systemets redigeringsside.</p>

	<p>Det er knyttet tilgjengelighetskrav til hvert miljø, som igjen dikterer SLA krav knyttet til bestillinger og håndtering av feil på underliggende systemer. Ler mer om SLA-nivåene på <a href="https://oslokommune.sharepoint.com/sites/abcff/SitePages/Kontinuit--og-beredskapsarbeid.aspx" target="_blank">SharePoint</a>.</p>

	<p>Importen av disse dataene skjer automatik hver natt</p>

	<hr>

	<form action="" autocomplete="off">
		<div class="form-group form-inline">
			<input size="30" style="width: 250px;" type="search" value="{{ search_term }}" name="search_term"
			placeholder="Business service inneholder.." class="form-control form-control-sm">
			<input type="submit" value="Søk" class="btn btn-primary btn-sm">
			<a class="btn btn-sm" href="?search_term=__all__">Vis alt</a>
		</div>
	</form>


<table class="table table-sm tablesorter excel">
<thead>
<tr>
	<th>Opprettet</th>
	<th>Oppdatert</th>
	<th>Aktiv?</th>
	<th>Nivå 1 Business Service (kategori)</th>
	<th>Nivå 2 Business Service Offering (miljø)</th>
	<th>Service classification</th>
	<th>Antall servere</th>
	<th>Antall databaser</th>
	<th>Mengde backup</th>
	<th>Tilknyttet system</th>
	<th>Driftplattform</th>
	<th>Miljø</th>
	{% comment %}
	<th>Kritikalitet</th>
	{% endcomment %}
	<th>Availability (SLA)</th>
	<th>Operation factor</th>
	<th>Kritikalitet</th>
</tr>
</thead>
<tbody>
{% for item in cmdbref %}
<tr {% if item.operational_status == 0 %} style="text-decoration: line-through; opacity: 30%;" {% endif %}>
	<td>{{ item.opprettet|timesince }}</td>
	<td>{{ item.sist_oppdatert|timesince }}</td>

	<td>
		{% include 'site_janeivetikke.html' with boolean=item.operational_status %}<br>
		{{ item.get_operational_status_display|default:"-" }}
	</td>

	<td>{{ item.parent_ref.navn|default:'?' }}</td>
	<td>
		{% comment %}
			{% if user.is_authenticated %}
			<a href="/admin/systemoversikt/cmdbref/{{ item.pk }}/change/">
				✎</a>
			{% endif %}
		{% endcomment %}


		<a href="{% url 'cmdb_bss' pk=item.pk %}">{{ item.navn }}</a>
		{% if item.is_bss %}<span> (gruppe)</span>{% endif %}
	</td>
	<td>
		{{ item.service_classification|default:"" }}
	</td>
	<td>{{ item.ant_devices }}</td>
	<td>{{ item.ant_databaser }}</td>
	<td>
		{{ item.backup_size|filesizeformat }}
	</td>
	<td>
		{% if item.parent_ref.systemreferanse %}
			{% url 'systemdetaljer' pk=item.parent_ref.systemreferanse.pk as url_system %}
			<a href="{{ url_system }}">{{ item.parent_ref.systemreferanse }}</a><br>
			<a style="color: #ff2116;" href="/admin/systemoversikt/cmdbbs/{{ item.parent_ref.pk }}/change/">✎ endre?</a>
		{% else %}
			<a style="color: #ff2116;" href="/admin/systemoversikt/cmdbbs/{{ item.parent_ref.pk }}/change/">✎ koble?</a>
		{% endif %}
	</td>

	<td>
		{% if item.parent_ref.systemreferanse %}
			{{ item.parent_ref.systemreferanse.driftsmodell_foreignkey|default:"Ikke koblet" }}
		{% else %}
			-
		{% endif %}
	</td>

	<td>{{ item.get_environment_display|default:"-" }}</td>

	{% comment %}
	<td>{{ item.get_kritikalitet_display|default:"X ukjent" }}</td>
	{% endcomment %}

	<td {% if not item.u_service_availability %} style="color: red;" {% endif %}>
		{{ item.u_service_availability_text|default:"T?" }}
	</td>
	<td {% if not item.u_service_operation_factor %} style="color: red;" {% endif %}>
		{{ item.u_service_operation_factor|default:"D?" }}
	</td>
	<td {% if not item.u_service_complexity %} style="color: red;" {% endif %}>
		{{ item.u_service_complexity|default:"K?" }}
	</td>

</tr>
{% endfor %}
</tbody>
</table>



	<h4>Business services uten kobling til et system</h4>
	<table class="table table-sm tablesorter excel">
	<thead>
	<tr>
		<th>Business service</th>
		<th>Koble?</th>
	</tr>
	</thead>
	<tbody>
	{% for bs in bs_uten_system %}
	<tr>
		<td>
			{{ bs }}
		</td>
		<td>
			<a href="/admin/systemoversikt/cmdbbs/{{ bs.pk }}/change/">✎ koble</a>
		</td>
	</tr>
	{% endfor %}
	</tbody>
	</table>


	<h4>Skjulte business services med databaser eller servere</h4>
	<table class="table table-sm tablesorter excel">
	<thead>
	<tr>
		<th>Business service</th>
		<th>Endre</th>
	</tr>
	</thead>
	<tbody>
	{% for bs in skjult_server_db %}
	<tr>
		<td><a href="/cmdb/bs/?search_term={{bs.navn}}">{{ bs.navn }}</a></td>
		<td>
			<a href="/admin/systemoversikt/cmdbbs/{{ bs.pk }}/change/">✎ rediger</a>
		</td>
	</tr>
	{% endfor %}
	</tbody>
	</table>


	<h4>Systemer angitt å kjøre på felles IKT-plattform som ikke er koblet til en business service</h4>
	<p>Viser ikke infrastrukturkomponenter</p>
	<table class="table table-sm tablesorter excel">
	<thead>
	<tr>
		<th>Systemnavn</th>
		<th>Plattform</th>
		<th>Systemeier</th>
		<th>Systemforvalter</th>
	</tr>
	</thead>
	<tbody>
	{% for s in system_uten_bs %}
	<tr>
		<td><a href="{% url 'systemdetaljer' pk=s.pk %}">{{ s.systemnavn }}</a></td>
		<td>{{ s.driftsmodell_foreignkey }}</td>
		<td>{{ s.systemeier|default:"?" }}</td>
		<td>{{ s.systemforvalter|default:"?" }}</td>
	</tr>
	{% endfor %}
	</tbody>
	</table>

	<h4>Systemer med Business Service kobling med angitt plattform annen enn felles IKT-plattform.</h4>
	<p>Viser ikke infrastrukturkomponenter</p>
	<table class="table table-sm tablesorter excel">
	<thead>
	<tr>
		<th>Systemnavn</th>
		<th>BS</th>
		<th>Plattform</th>
		<th>Systemeier</th>
		<th>Systemforvalter</th>
	</tr>
	</thead>
	<tbody>
	{% for s in bs_utenfor_fip %}
	<tr>
		<td><a href="{% url 'systemdetaljer' pk=s.pk %}">{{ s.systemnavn }}</a></td>
		<td><a href="/cmdb/bs/?search_term={{s.bs_system_referanse.navn}}">{{ s.bs_system_referanse.navn }}</a></td>
		<td>{{ s.driftsmodell_foreignkey }}</td>
		<td>{{ s.systemeier|default:"?" }}</td>
		<td>{{ s.systemforvalter|default:"?" }}</td>
	</tr>
	{% endfor %}
	</tbody>
	</table>


	<h4>Utfasede business services som fremdeles er koblet mot et system</h4>
	<a href="{% url 'cmdb_bs_disconnect' %}">Løskoble alle</a>
	<table class="table table-sm tablesorter excel">
		<thead>
		<tr>
			<th>Business service</th>
			<th>Koblet system</th>
		</tr>
		</thead>
		<tbody>
		{% for bs in utfasede_bs %}
		<tr>
			<td>{{ bs }}</td>
			<td>
				{% if bs.systemreferanse %}
					{{ bs.systemreferanse.systemnavn }}
					<a style="color: #ff2116;" href="/admin/systemoversikt/cmdbbs/{{ bs.pk }}/change/">✎ frakoble?</a>
				{% else %}
					Ikke koblet
				{% endif %}

			</td>
		</tr>
		{% endfor %}
		</tbody>
	</table>



{% endblock hovedinnhold %}