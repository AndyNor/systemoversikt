{% extends "rapport_index.html" %}
{% load humanize %}
{% load static %}

{% block ekstrameny_business_service %}
{% endblock ekstrameny_business_service %}

{% block overskrift %}
	Entra ID Service principals {% if dager_gammelt %} opprettet siste {{dager_gammelt}} dager {% endif %}
{% endblock overskrift %}

{% block hovedinnhold %}


<p style="background-color: {{ integrasjonsstatus.color }};">
Service principals fra Entra ID ble sist synkronisert {{ integrasjonsstatus.dato_sist_oppdatert|date:"d.M Y"|default:"ukjent" }} ({{integrasjonsstatus.dato_sist_oppdatert|timesince}}) ({{integrasjonsstatus.script_navn}})</p>

	<form action="" autocomplete="off">
		<div class="form-group form-inline">
			<input size="30" style="width: 250px;" type="search" value="{% if search_term %}{{ search_term }}{% else %}{% endif %}" name="search_term"
			placeholder="Navn, appId, objectID, beskrivelse.." class="form-control form-control-sm">
			<input type="submit" value="Søk" class="btn btn-primary btn-sm">
			<a class="btn btn-sm" href="?search_term=__all__">Vis alt</a>
		</div>
	</form>

<p>En "applikasjon" er en registrering av en app i Entra ID med metadata som URL og tillatelser. En slags "mal". Når du oppretter en applikasjon, opprettes det automatisk også en service principal i vår tenant. En applikasjon kan opprettes slik at alle med Entra ID kan ta den i bruk. F.eks. av Microsoft, eller den kan opprettes spesifikt for én tenant, slik som for oss i Oslo kommune. Når vi tar i bruk en tredjepartsapplikasjon eller lager en selv, får de en egen kategorisering kalt "enterprise application" som da representerer "vår" instans av applikasjonen. Du kan tenke på det som vår "kopi" av malen.</p>
<p>En "service principal" er ibruktakelsen/instansen av applikasjonen i vår tenant, og er objektet som faktisk har tillatelser og tilganger f.eks. via API-nøkler eller sertifikater knyttet til seg. Det er mulig å lage service principals uten en tilknyttet app. Dette gjøres ofte for script og automatiseringsprosesser.</p>
<p>Her vises bare service principals, siden disse skal dekker alle applikasjoner. Du kan koble disse til systemer fra redigeringssiden for det enkelte system. Du vil da få opp detaljer om rettigheter og nøkkelutløp på systemdetaljesiden. Det finnes også andre typer service principals som f.eks. representerer managed identities.</p>

{% if not vise_managed_identity %}<i>Viser ikke ManagedIdentity</i>{% endif %}

{% if search_term %}<i>Du søkte på <b>{{search_term}}</b></i>{% endif %}


	<table class="table table-sm tablesorter excel">
	<thead>
		<th>Aktiv</th>
		<th>Opprettet</th>
		<th>Applikasjonsnavn</th>
		<th>Type</th>
		<th>Publisher</th>
		<th>Eier</th>
		<th>Publisert til</th>
		<th>Enterprise App?</th>
		{% comment %}<th>Type</th>{% endcomment %}
		{% comment %}<th>Tags</th>{% endcomment %}
		<th>Risikonivå</th>
		{% comment %}<th>Vurdering</th>{% endcomment %}
		<th>Gitte rettigheter</th>
		<th>Antall rettigheter</th>
		<th>Notater</th>
	</thead>
	<tbody>
	{% for a in applikasjoner %}
		<tr>
			<td>{{a.active|yesno:"Aktiv,Deaktiv"}}</td>
			<td>{{a.createdDateTime|date:"Y-m-d"}}
			<td><b>{{a.displayName|truncatechars:35}}</b><br>

				{% if a.from_applications %}
					<a target="_blank" href="https://portal.azure.com/#view/Microsoft_AAD_RegisteredApps/ApplicationMenuBlade/~/Overview/appId/{{a.appId}}">{{a.appId}}</a>
				{% else %}
					<a target="_blank" href="https://portal.azure.com/#view/Microsoft_AAD_IAM/ManagedAppMenuBlade/~/Overview/objectId/{{a.appId}}">{{a.appId}}</a>
				{% endif %}


				{% if a.systemreferanse.all|length > 0 %}
				<br><br>Koblet til følgende system:
				{% for system in a.systemreferanse.all %}
					<li>{{ system }}</li>
				{% endfor %}
				{% endif %}
			</td>

			<td>{{a.servicePrincipalType}}</td>

			<td>{{a.publisherName|default:""}}</td>

			<td>
				{% for item in a.owner_json.value %}
					{{item.userPrincipalName}}<br>
				{% endfor %}
			</td>

			<td>
				{% for item in a.assigned_to_json.value %}
					{{item.principalDisplayName}}<br>
				{% endfor %}
			</td>

			<td>
				{{a.er_enterprise_app|yesno:"Ja, Nei"}}
				<br>{{a.from_applications|yesno:"\applications,\servicePrincipals"}}
			</td>
			{% comment %}<td>{{a.servicePrincipalType}}<br>{{a.from_applications|yesno:"\applications,\servicePrincipals"}}</td>{% endcomment %}
			{% comment %}<td>{{a.tags}}</td>{% endcomment %}
			<td>{{a.risikonivaa_autofill}}</td>
			{% comment %}<td>{% if a.vurdering %} {{ a.sist_oppdatert|date:"Y-m-d"}}<br>{{ a.vurdering }} {% else %} -mangler- {% endif %}</td>{% endcomment %}
			<td>
				{% for r in a.requiredResourceAccess.all %}

				<li>
					<span style="color: {{ r.risk_color }};">
						{{ r.permission_type }} {{ r.resourceAppStr }} {{ r.adminConsentDisplayName }} ({{ r }})
					</span>
				</li>

				{% endfor %}
			</td>
			<td>{{ a.antall_graph_rettigheter }}</td>
			<td style="max-width: 200px; word-wrap: break-word; white-space: normal;">{{a.notes|default:"-"}}</td>
		</tr>
	{% endfor %}
	</tbody>
	</table>

{% endblock hovedinnhold %}